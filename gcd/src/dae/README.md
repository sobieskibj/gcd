Code ported from the original Diffusion Autoencoders codebase and adapted.